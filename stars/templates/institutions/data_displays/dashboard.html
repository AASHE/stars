{% extends 'institutions/data_views/index.html' %}

{% load thumbnail %}

{% block title %}Dashboard{% endblock %}

{% block body_onload %}{{ block.super }}initialize();{% endblock %}

{% block extra_head %}
	{{ block.super }}
	<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false" type="text/javascript"></script>
	
	<script type="text/javascript">
		function initialize() {
			school_list = [
					{% for i in institution_list %}
						{% spaceless %}
						{% if i.institution.latitude and i.institution.longitude %}
							{
								lat: {{ i.institution.latitude }},
								lon: {{ i.institution.longitude }},
								title: "{{ i.institution.org_name }}",
								content: "<b>{{ i.institution.org_name }}</b><p>
								{% if i.rating %}
									{% thumbnail i.rating.image_large "70x70" as im %}
									    <img src='{{ im.url }}' style='margin: 0px 15px 5px 0px;' align='left' />
									{% endthumbnail %}
								{% else %}
									<img src='{{ i.image_path }}' style='margin: 0px 15px 5px 0px;' align='left' />
								{% endif %}
								<span style='white-space: nowrap;'><i>Registration Date:</i><br/>&nbsp;{{ i.ss.date_registered }}</span><br/>
								{% if i.rating %}
									<span style='white-space: nowrap;'><i>Submission Date:</i><br/>&nbsp;{{ i.ss.date_submitted }}</span><br/>
									<span style='display: block;margin: 5px 0px 0px 0px;padding: 0px;text-align: center'><a href='{{ i.ss.get_scorecard_url }}'>STARS Report</a></span>
								{% endif %}
								</p>"
							}
							{% if not forloop.last %},{% endif %}
						{% endif %}
						{% endspaceless %}
					{% endfor %}
			]
		
			var myLatlng = new google.maps.LatLng(0,0);
			  var myOptions = {
			    zoom: 4,
			    center: myLatlng,
			    disableDefaultUI: true,
			    scaleControl: true,
			    navigationControl: true,
			    mapTypeControl: true,
			    scrollwheel: false,
			    mapTypeControlOptions: {
			      style: google.maps.MapTypeControlStyle.DROPDOWN_MENU
			    },
			    mapTypeId: google.maps.MapTypeId.TERRAIN
			  }
			  var map = new google.maps.Map(document.getElementById("map_canvas"), myOptions);
			   
			  bounds = new google.maps.LatLngBounds();
			  
			  infoWindow = new google.maps.InfoWindow({
			  	maxWidth: 450
			  });
			  
			  function createMarker(school) {
			  	var point = new google.maps.LatLng(school['lat'], school['lon']);
			  	bounds.extend(point)
			  	marker = new google.maps.Marker({
			      position: point, 
			      map: map, 
			      icon: "/media/static/images/map_icons/participant.png",
			      title: school['title']
			  	});
			    
			  	// Register a click listener on each marker created.
			    google.maps.event.addListener(marker, 'click', (function(markerArg, content) {
			      return function() {
			        infoWindow.setContent(content);
			        infoWindow.open(map, markerArg);
			      };
			    })(marker, school['content']));

			  }
			  
			  for ( i = 0; i < school_list.length; i++ ) {
			  		createMarker(school_list[i]);
			  }
			  map.fitBounds(bounds);
	  }
  	</script>
{% endblock %}

{% block content %}
	<div class='inner20'>
		<h1>STARS Dashboard</h1>
		<h2>Participants</h2>
		<div id="map_canvas" style="width:98%; height:400px; border: 1px solid #aaa; margin-top: 5px; padding: 2px;"></div>
		<hr style='clear:both' />
	</div>
{% endblock %}